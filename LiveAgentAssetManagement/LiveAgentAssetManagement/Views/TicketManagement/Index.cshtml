@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css">
<p></p>
<div class="container">
    <table id="data-table" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Ticket Subject</th>
                <th>Ticket Created Date</th>
            </tr>
        </thead>
    </table>

</div>
<div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Ticket Info</h4>
            </div>
            <form id="updateTicketForm" action="https://sinnoxkw.ladesk.com/api/conversations/090845c2/fields" method="POST" enctype='application/json'>
                <input type="hidden" id="ticketCustomField" name='customfields' value='[{"code":"AssetID","value":"99999"}]'>
                <input type="hidden" name='apikey' value='42f95581f7bfa0656b85b24950232bb5'>

                <div class="modal-body">

                    <div class="form-group">
                        <input type="hidden" id="ticketId" value="" />
                        <label for="subject">Subject:</label>
                        <label id="subject" style="color: red"></label>
                    </div>
                    <div class="form-group">
                        <label>Asset Sr No:</label>
                        <div id="bloodhound">
                            <input class="form-control" id="txtAssetSearch" autocomplete="off" type="text" placeholder="Search Asset">
                        </div>
                    </div>
                    <div>
                        <table id="assetInfo" class="table">
                            <thead style="background-color: #3179a2; color: white;">
                                <tr>
                                    <th>Asset Name</th>
                                    <th>Brand</th>
                                    <th>Category</th>
                                    <th>Department</th>
                                    <th>Supplier</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" value="" id="btnSave" class="btn btn-default">Submit</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap.min.js"></script>
    <script type="http://twitter.github.io/typeahead.js/releases/latest/typeahead.bundle.js">
    </script>
    <script type="text/javascript" src="http://cdn.rawgit.com/bassjobsen/Bootstrap-3-Typeahead/master/bootstrap3-typeahead.min.js"></script>
    <script>
        $(function () {
            $('#txtAssetSearch').typeahead({
                hint: true,
                highlight: true,
                minLength: 1,
                source: function (request, response) {
                    $.ajax({
                        url: '../Asset/SearchAsset',
                        data: {
                            AssetCode: request
                        },
                        dataType: "json",
                        type: "GET",
                        contentType: "application/json; charset=utf-8",
                        success: function (data) {
                            var items = [];
                            var map = {};
                            $.each(data,
                                function (i, item) {
                                    var id = item.AssetId;
                                    var name = item.AssetSrNo;
                                    map[name] = { id: id, name: name };
                                    items.push(name);
                                });
                            response(items);
                            $(".dropdown-menu").css("height", "auto");
                        },
                        error: function (err) {
                            alert(err.responseText);
                        },
                        failure: function (err) {
                            alert(err.responseText);
                        }
                    });
                },
                updater: function (item) {
                    $('#assetInfo tbody').empty();
                    $.ajax({
                        url: '../Asset/SearchAsset',
                        data: {
                            AssetCode: item
                        },
                        dataType: "json",
                        type: "GET",
                        contentType: "application/json; charset=utf-8",
                        success: function (data) {
                            $.each(data,
                                function (i, aitem) {
                                    var row = '<tr>';
                                    row += '<td>' + aitem.AssetName + '</td>';
                                    row += '<td>' + aitem.BrandName + '</td>';
                                    row += '<td>' + aitem.CategoryName + '</td>';
                                    row += '<td>' + aitem.DepartmentName + '</td>';
                                    row += '<td>' + aitem.Supplier + '</td>';
                                    row += '</tr>';

                                    $('#assetInfo tbody').append(row);

                                    // updating vallues to submit form
                                    var ticketId = $(".modal-content #ticketId").val();
                                    $('#updateTicketForm')
                                        .attr('action',
                                        'https://sinnoxkw.ladesk.com/api/conversations/' + ticketId + '/fields');

                                    $("#ticketCustomField").val('[{"code":"AssetID","value":"' + aitem.AssetId + '"},{"code":"AssetName","value":"' + aitem.AssetName + '"},{"code":"AssetSupplier","value":"' + aitem.Supplier + '"},{"code":"AssetDepartment","value":"' + aitem.DepartmentName + '"}]');

                                });
                        },
                        error: function (response) {
                            console.log(response.responseText);
                        },
                        failure: function (response) {
                            console.log(response.responseText);
                        }
                    });
                    // $('[id*=hfCustomerId]').val(map[item].id);
                    return item;
                }
            });
        });


        $(document).on("click",
            ".open-Model",
            function () {
                var subject = $(this).data('subject');
                var id = $(this).data('id');

                $(".modal-content #subject")[0].innerHTML = subject;
                $(".modal-content #ticketId").val(id);
            });

        //$(document).on("click",
        //    "#btnSave",
        //    function () {
        //        if ($("#assetInfo tbody tr").length === 0) {
        //            alert("Serach Asset to assign to the ticket");
        //        } else {
        //            alert($(".modal-content #ticketId").val());
        //            $("#myModal").modal('hide');
        //            var postData = { customfields: [{ "code": "AssetID", "value": "asdf" }] };

        //            //$.post(
        //            //    "https://sinnoxkw.ladesk.com/api/conversations/090845c2/fields?apikey=42f95581f7bfa0656b85b24950232bb5",
        //            //    postData,
        //            //    function (result) {
        //            //        console.log(result);
        //            //    });
        //            //$.ajax({
        //            //    url: "https://sinnoxkw.ladesk.com/api/conversations/090845c2/fields?apikey=42f95581f7bfa0656b85b24950232bb5",
        //            //    method: "POST",
        //            //    contentType: "application/json",
        //            //    data: postData,
        //            //    success: function (result) {
        //            //        console.log(result);
        //            //    }
        //            //});
        //        }
        //    });

        $(document).ready(function () {
            $.ajax({
                url:
                "https://sinnoxkw.ladesk.com/api/v3/tickets?_page=1&_perPage=5000&_sortDir=ASC&apikey=42f95581f7bfa0656b85b24950232bb5",
                method: "GET",
                success: function (result) {

                    var filterdResult = result.filter(function (ticket) {
                        return ticket.status === 'N';
                    });

                    $("#data-table").DataTable({
                        order: [[1, "desc"]],
                        oLanguage: {
                            sProcessing:
                            '<button class="btn btn-lg btn-warning"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span> Loading...</button>'
                        },
                        processing: true,
                        data: filterdResult,
                        columns: [
                            { data: 'subject' },
                            { data: 'date_created' }
                        ],
                        columnDefs: [
                            {
                                "targets": 0,
                                "render": function (data, type, row) {
                                    return '<a onclick="OnTicketClick()" data-toggle="modal" data-id="' +
                                        row.id +
                                        '" data-subject="' +
                                        row.subject +
                                        '" id="edit' +
                                        row.id +
                                        '"  value="' +
                                        row.id +
                                        '" href="#myModal" class="open-Model" >' +
                                        row.subject +
                                        '</a>';
                                }
                            }
                        ]
                    });
                }
            });
        });

        function OnTicketClick() {
            $('#assetInfo tbody').empty();
            $('#txtAssetSearch').val('');
        }
    </script>
}